#!/bin/bash

echo "üîó GUIDE COMPLET - CONFIGURATION WEBHOOKS STRIPE"
echo "================================================"
echo ""

echo "üìã √âTAPES √Ä SUIVRE :"
echo ""

echo "1Ô∏è‚É£ D√âPLOYER LES EDGE FUNCTIONS SUPABASE"
echo "----------------------------------------"
echo "# Connectez-vous √† Supabase (si pas d√©j√† fait)"
echo "supabase login"
echo ""
echo "# D√©ployez les fonctions"
echo "supabase functions deploy create-subscription"
echo "supabase functions deploy stripe-webhook"
echo ""
echo "# R√©cup√©rez l'URL de votre projet"
echo "supabase status"
echo ""

echo "2Ô∏è‚É£ CONFIGURER LE WEBHOOK DANS STRIPE"
echo "-------------------------------------"
echo "üåê Allez sur : https://dashboard.stripe.com/webhooks"
echo ""
echo "üëÜ Cliquez sur '+ Add endpoint'"
echo ""
echo "üìù URL de l'endpoint :"
echo "   https://[VOTRE-PROJET-ID].supabase.co/functions/v1/stripe-webhook"
echo "   (Remplacez [VOTRE-PROJET-ID] par votre vrai ID Supabase)"
echo ""
echo "üì∫ √âv√©nements √† s√©lectionner :"
echo "   ‚úÖ checkout.session.completed"
echo "   ‚úÖ customer.subscription.created"
echo "   ‚úÖ customer.subscription.updated" 
echo "   ‚úÖ customer.subscription.deleted"
echo "   ‚úÖ invoice.payment_succeeded"
echo "   ‚úÖ invoice.payment_failed"
echo ""
echo "üíæ Cliquez sur 'Add endpoint'"
echo ""

echo "3Ô∏è‚É£ R√âCUP√âRER LE WEBHOOK SECRET"
echo "-------------------------------"
echo "üìã Dans l'endpoint que vous venez de cr√©er :"
echo "   - Cliquez sur l'endpoint"
echo "   - Allez dans 'Signing secret'"
echo "   - Cliquez sur 'Reveal' ou 'Click to reveal'"
echo "   - Copiez la valeur (commence par 'whsec_...')"
echo ""

echo "4Ô∏è‚É£ AJOUTER LES VARIABLES DANS VERCEL"
echo "------------------------------------"
echo "üåê Allez sur : https://vercel.com/dashboard"
echo "üëÜ S√©lectionnez votre projet Cureliah"
echo "‚öôÔ∏è  Allez dans Settings > Environment Variables"
echo ""
echo "üîë Ajoutez ces variables :"
echo "   Variable 1:"
echo "     Name: STRIPE_WEBHOOK_SECRET"
echo "     Value: whsec_... (la valeur copi√©e √† l'√©tape 3)"
echo "     Environment: Production"
echo ""
echo "   Variable 2:"
echo "     Name: STRIPE_SECRET_KEY"
echo "     Value: sk_live_... (votre cl√© secr√®te Stripe)"
echo "     Environment: Production"
echo ""
echo "   Variable 3:"
echo "     Name: SUPABASE_SERVICE_ROLE_KEY"
echo "     Value: (votre service role key Supabase)"
echo "     Environment: Production"
echo ""

echo "5Ô∏è‚É£ RED√âPLOYER VOTRE APPLICATION"
echo "--------------------------------"
echo "üîÑ Dans Vercel :"
echo "   - Allez dans l'onglet 'Deployments'"
echo "   - Cliquez sur 'Redeploy' sur le dernier d√©ploiement"
echo "   OU"
echo "   - Faites un nouveau push git"
echo ""

echo "6Ô∏è‚É£ TESTER LES WEBHOOKS"
echo "----------------------"
echo "üß™ Dans Stripe Dashboard :"
echo "   - Allez dans votre webhook"
echo "   - Cliquez sur 'Send test webhook'"
echo "   - S√©lectionnez 'checkout.session.completed'"
echo "   - Cliquez sur 'Send test webhook'"
echo ""
echo "‚úÖ V√©rifiez que le statut est '200' (succ√®s)"
echo ""

echo "üéØ R√âSUM√â DES URLs IMPORTANTES :"
echo "Stripe Dashboard: https://dashboard.stripe.com/webhooks"
echo "Vercel Dashboard: https://vercel.com/dashboard"
echo "Supabase Dashboard: https://supabase.com/dashboard"
echo ""

echo "üìû En cas de probl√®me :"
echo "   - V√©rifiez les logs Supabase : supabase functions logs stripe-webhook"
echo "   - V√©rifiez les logs Vercel dans l'onglet 'Functions'"
echo "   - Les webhooks Stripe ont un d√©lai de retry automatique"

echo ""
echo "‚ú® Une fois termin√©, vos paiements Stripe seront enti√®rement fonctionnels !"
